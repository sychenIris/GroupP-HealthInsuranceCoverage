library(tidyr)
library(dplyr)
library(purrr)
tweets <- tweets.df %>%
select(id, statusSource, text, created) %>%
extract(statusSource, "source", "Twitter for (.*?)<") %>%
filter(source %in% c("iPhone", "Android"))
rm(list=ls())
library(leaflet)
library(maps)
library(rgdal)
library(DT)
library(ggplot2)
library(ggthemes)
library(plotly)
library(magrittr)
library(readxl)
library(plyr)
library(dplyr)
library(tidyr)
library(readr)
library(stringi)
library(RColorBrewer)
library(countrycode)
require(gridExtra)
## IMPORT DATA
# General ACA information
aca_general_raw <- read_excel("Data/states_aca_general.xlsx", sheet=2, col_names=FALSE)
# States health outcomes
health_ind_raw <- read_excel("Data/states_health_ind.xlsx", sheet=4, col_names=FALSE)
# Insurance coverage data
# Long format
insurance_long <- read_excel("Data/insurance-clean.xlsx", sheet=1, col_names=TRUE)
# Wide format
insurance <- read_excel("Data/insurance-clean.xlsx", sheet=2, col_names=TRUE)
# Demographic information
demographics1 <- read.csv("Data/Population_Age_Income.csv", header = TRUE)
# Provided with Assignment 4 (want the yearly population data)
demographics2 <- read_excel("Data/PopulationEstimates.xls")
# Election Results
election <- read_excel("Data/US_Presidential_Results_by_State_1828-2016.xlsx", sheet=2, col_names=FALSE)
## CLEAN DATA
# List of states abbreviations
state_abbreviations <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")
## CLEAN INSURANCE RATES DATA (WIDE)
# Drop unnecessary columns
insurance <- insurance[1:50, -1]
# Rename variables
colnames(insurance) <- c("state_abb", "state", "uninsured_num_2008", "uninsured_pct_2008", "uninsured_num_2009", "uninsured_pct_2009", "uninsured_num_2010", "uninsured_pct_2010", "uninsured_num_2011", "uninsured_pct_2011", "uninsured_num_2012", "uninsured_pct_2012", "uninsured_num_2013", "uninsured_pct_2013", "uninsured_num_2014", "uninsured_pct_2014", "uninsured_num_2015", "uninsured_pct_2015")
# Create variables for insurance rates
insurance$insured_pct_2008 <- 100 - insurance$uninsured_pct_2008
insurance$insured_pct_2009 <- 100 - insurance$uninsured_pct_2009
insurance$insured_pct_2010 <- 100 - insurance$uninsured_pct_2010
insurance$insured_pct_2011 <- 100 - insurance$uninsured_pct_2011
insurance$insured_pct_2012 <- 100 - insurance$uninsured_pct_2012
insurance$insured_pct_2013 <- 100 - insurance$uninsured_pct_2013
insurance$insured_pct_2014 <- 100 - insurance$uninsured_pct_2014
insurance$insured_pct_2015 <- 100 - insurance$uninsured_pct_2015
# Reorder variables
insurance <- insurance[ , c("state_abb", "state", "uninsured_num_2008", "uninsured_pct_2008", "insured_pct_2008", "uninsured_num_2009", "uninsured_pct_2009", "insured_pct_2009", "uninsured_num_2010", "uninsured_pct_2010", "insured_pct_2010", "uninsured_num_2011", "uninsured_pct_2011", "insured_pct_2011", "uninsured_num_2012", "uninsured_pct_2012", "insured_pct_2012", "uninsured_num_2013", "uninsured_pct_2013", "insured_pct_2013", "uninsured_num_2014", "uninsured_pct_2014", "insured_pct_2014", "uninsured_num_2015", "uninsured_pct_2015", "insured_pct_2015")]
## CLEAN INSURANCE RATES DATA (LONG)
# Rename variables
colnames(insurance_long) <- c("year", "state", "population", "uninsured_num", "uninsured_pct", "insured_num", "insured_pct")
# Add state abbreviations
# First create a look-up table (based on wide data)
state_abb_lookup <- insurance[ , c("state", "state_abb")]
# Then do the matching
insurance_long$state_abb <- state_abb_lookup$state_abb[match(insurance_long$state, state_abb_lookup$state)]
# Reorder variable
insurance_long <- insurance_long[ , c(1:2, ncol(insurance_long), 3:(ncol(insurance_long)-1))]
# Order observations (by state, then by year)
insurance_long <- insurance_long[order(insurance_long$state, insurance_long$year), ]
## CLEAN ACA GENERAL DATA
# Keep only relevant rows and columns
aca_general <- aca_general_raw[6:57, 1:73]
# Label variables for ACA general data
names(aca_general) <- c("state", "unins_all_pct_10", "unins_all_pct_15", "unins_all_decr_pct", "unins_all_decr", "cov_emp", "cov_parents_plan", "lifetime_lim_preACA_tot", "lifetime_lim_preACA_child", "lifetime_lim_preACA_adultM", "lifetime_lim_preACA_adultF", "cov_private_tot", "cov_private_child", "cov_private_adultM", "cov_private_adultF", "premium_emp_avg_growth_pct_00to10", "premium_emp_avg_growth_pct_10to15", "premium_emp_savings_15", "premium_emp_savings_16", "MLR_rebate_beneficiaries_12", "MLR_rebate_amt_12", "MLR_rebate_beneficiaries_13", "MLR_rebate_amt_13", "MLR_rebate_beneficiaries_14", "MLR_rebate_amt_14", "MLR_rebate_beneficiaries_15", "MLR_rebate_amt_15", "MLR_rebate_amt_12to15", "medicaid_enroll_13", "medicaid_enroll_16", "medicaid_enroll_child_13", "medicaid_enroll_incr_13to16", "medicaid_full_duals", "medicaid_partial_duals", "medicaid_full_or_partial_duals", "state_has_expanded", "insurance_incr_medicaid", "cholest_scr_incr_medicaid", "mammogram_incr_medicaid", "papsmear_incr_medicaid", "clinic_care_incr_medicaid", "all_care_incr_medicaid", "phycisian_visit_ann_incr_medicaid", "depression_decr_medicaid", "good_health_incr_medicaid", "deaths_ann_decr_medicaid", "catastrophic_oop_ann_decr_medicaid", "indebted_ppl_decr_medicaid", "fed_spending_net_incr_inMil", "uncompensated_care_decr_inMil", "mental_substance_elig_medicaid_share", "mental_substance_elig_medicaid", "preexisting_condition_09", "cov_mkt_plan_16", "cov_mkt_16", "receive_tax_credit", "avg_tax_credit", "receive_cost_sharing", "avg_num_mkt_plans_avail_17", "cov_mkt_under75D_pct", "cov_mkt_under100D_pct", "cov_offmkt_elig_tax_credit", "rate_review_funds_to_state", "HIECP_grant_award_to_state", "medicare_enroll_16", "medicare_benef_donuthole", "medicare_benef_donuthole_savings_tot", "medicare_benef_donuthole_savings_avg", "medicare_partB_free_prev_services", "medicare_partB_free_prev_services_share", "medicare_incr_readmit_rate", "medicare_avoided_readmit", "accountable_care_org_num")
# Trim white space on state variable
aca_general$state <- stri_trim_both(aca_general$state)
# Change format of variables
# Apart from T/F variable for "state has expanded"
aca_general$state_has_expanded[aca_general$state_has_expanded=="yes"] <- TRUE
aca_general$state_has_expanded[aca_general$state_has_expanded=="no"] <- FALSE
# Convert others to numeric form
for (j in c(2:35, 37:73)) {
aca_general[[j]] <- as.numeric(aca_general[[j]])
}
# Save USA data separately
aca_general_USA <- aca_general[aca_general$state=="United States", ]
# Drop USA and DC data
aca_general <- aca_general[!(aca_general$state %in% c("United States", "District of Columbia")), ]
# Add state abbreviations
aca_general$state_abb <- state_abbreviations
aca_general <- aca_general[ , c(1, ncol(aca_general), 2:(ncol(aca_general)-1))]
# Drop raw data
rm(aca_general_raw)
## CLEAN HEALTH INDICATOR DATA
# Keep only relevant rows and columns
health_ind <- health_ind_raw[4:6703, c(1, 3:6)]
# Label variables
names(health_ind) <- c("state", "measure", "year", "rate", "rank")
# Simplify date (years) - only keep last year if range was given
health_ind$year[health_ind$year=="07/2009 - 06/2012"] <- "2012"
health_ind$year[health_ind$year=="07/2010 - 06/2013"] <- "2013"
health_ind$year[health_ind$year=="07/2012 - 06/2015"] <- "2015"
health_ind$year[health_ind$year=="10/2013-9/2014"] <- "2014"
health_ind$year[health_ind$year=="2008-09"] <- "2009"
health_ind$year[health_ind$year=="2010-11"] <- "2011"
health_ind$year[health_ind$year=="2011-12"] <- "2012"
health_ind$year[health_ind$year=="2011/12"] <- "2012"
health_ind$year[health_ind$year=="2012-13"] <- "2013"
health_ind$year[health_ind$year=="2013-14"] <- "2014"
health_ind$year[health_ind$year=="2013(Q2-Q4)"] <- "2013"
health_ind$year[health_ind$year=="2014-15"] <- "2015"
health_ind$year[health_ind$year=="2015(Q2-Q4)"] <- "2015"
# Export to excel to manually label variable names
unique_measures <- unique(as.factor(health_ind$measure))
# Copied in from excel sheet
unique_measures_relabelled <- c("a.summary_access", "a.unins_adult", "a.unins_child", "a.no_care_bc_cost_adult", "a.high_OOP_relative_under65", "a.at_risk_no_routine_doc_adult", "a.no_dental_adult", "q.summary_prev_treat", "q.with_usual_care_adult", "q.with_cancer_screening_adult", "q.with_vaccines_adult", "q.with_medical_home_child", "q.with_prev_medical_dental_child", "q.with_mental_healthcare_child", "q.with_vaccines_infant", "q.drug_should_avoid_medicare", "q.drug_should_avoid_3conditions_medicare", "q.good_health_provider_medicare", "q.mortality_4conditions_medicare", "q.CLABSI_infection_ratio", "q.info_recovery_hospitalized", "q.good_hospital_staff_hospitalized", "q.improve_mobility_homehealth", "q.improved_wounds_homehealth", "q.sores_NHres", "q.antipsychotic_med_NHres", "u.summary_avoidable_hosp_cost", "u.hosp_asthma_child", "u.hosp_ambulatory_65to74yrs", "u.hosp_ambulatory_above75yrs", "u.30day_hosp_readmit_medicare", "u.30day_hosp_readmit_NHres", "u.hosp_6mos_NHres", "u.hosp_medicare_homehealth", "u.avoidable_ER_medicare", "u.tot_reimb_employer_ins", "u.tot_reimb_medicare", "h.summary_healthy_lives", "h.deaths_amenable", "h.yrs_lost_potential_life_before75", "h.deaths_breast_cancer_F", "h.deaths_colorectal_cancer", "h.deaths_suicide", "h.deaths_infant_mortality", "h.poor_health_adult", "h.smoke_adult", "h.obese_adult", "h.obese_child", "h.poor_dental_adult", "u.premium_emp_private", "u.premium_emp_private_unadj", "u.reimb_medicare_unadj", "u.deaths_amenable_black", "u.deaths_amenable_white", NA, "q.with_prev_screening_above50yrs", NA)
# Replace variable names with abbreviated version
for (i in 1:57) {
health_ind$measure <- replace(health_ind$measure, health_ind$measure==unique_measures[i], unique_measures_relabelled[i])
}
# Remove the NA's
health_ind <- health_ind[!is.na(health_ind$measure), ]
# Remove duplicates
# By state, measure.year
health_ind <- health_ind[!duplicated(health_ind[ , 1:3]), ]
# Interact measure and year
health_ind$measure_year <- interaction(health_ind$measure, health_ind$year)
# Convert to character variable
health_ind$measure_year <- as.character(health_ind$measure_year)
# Pre-reshape: Store existing data as "long"
health_ind_long <- health_ind
# Reshape wide
health_ind <- as.data.frame(cbind(health_ind$state, health_ind$measure_year, health_ind$rate))
# Drop rank data for now
names(health_ind) <- c("state", "measure_year", "rate")
health_ind <- reshape(health_ind,
idvar = "state",
timevar = "measure_year",
direction = "wide")
# Drop "rate" from the name
names(health_ind)[2:ncol(health_ind)] <- substr(names(health_ind), 6, nchar(names(health_ind)))[2:ncol(health_ind)]
# Drop variables who have all entries as NA
# Due to 'unbalanced panel' in reshaping
# First create a vector to record if variable is all NA
variable_all_NA <- vector(mode="logical", length=ncol(health_ind))
for (j in 1:ncol(health_ind)) {
if(sum(is.na(health_ind[[j]]))==52) {
variable_all_NA[j] <- TRUE
}
}
# Only keep the variables that are NOT all NA
health_ind <- health_ind[ , !variable_all_NA]
# Change format of variables
# To character variable
health_ind$state <- as.character(health_ind$state)
# To numeric variable
for (j in c(2:164)) {
health_ind[[j]] <- as.character(health_ind[[j]])
health_ind[[j]] <- as.numeric(health_ind[[j]])
}
# Save USA data separately
health_ind_USA <- health_ind[health_ind$state=="United States", ]
# Drop USA and DC data
health_ind <- health_ind[!(health_ind$state %in% c("United States", "District of Columbia")), ]
# Label state abbreviations
health_ind$state_abb <- state_abbreviations
View(health_ind)
